create table kha2.customers(
	id serial primary key,
	name varchar(100),
	credit_limit numeric(10,2)
);
create table kha2.orders(
	id serial primary key,
	customer_id int REFERENCES kha2.customers(id),
	order_amount numeric(10,2)
);

INSERT INTO kha2.customers (name, credit_limit) VALUES
('Nguyen Van A', 5000.00),
('Tran Thi B', 7500.00),
('Le Van C', 3000.00),
('Pham Thi D', 10000.00),
('Hoang Van E', 4500.00);
select * from kha2.customers
INSERT INTO kha2.orders (customer_id, order_amount) VALUES
(1, 1200.00),
(1, 800.00),
(2, 2500.00),
(3, 500.00),
(5, 1500.00);
select * from kha2.orders
-- kiem tra hanj muc cua khach hang
-- kiem tra tong hoa don
-- roi so sanh han muc voi tong hoa don
create or replace  FUNCTION check_credit_limit()
returns trigger as $$
DECLARE
	order_total numeric(10,2);
	custom_limit numeric(10,2);
begin	
-- Xem han muc cua khach hang
	select credit_limit into custom_limit
	from kha2.customers c
	where id = new.customer_id;

-- Xem tong don hang
	select sum(order_amount) into order_total
	from kha2.orders o
	where customer_id = new.customer_id;

--  kiem tra neu tong don hang > han muc KH thi raise exception
	if (order_total + new.order_amount) > custom_limit then
		raise exception 'Số tiền của đơn hàng không thể vượt quá hạn mức tài khoản của người dùng';
	end if;
	return new;
end;
$$ LANGUAGE plpgsql;

create trigger trigger_check_credit_before before insert on kha2.orders
for each row 
execute function check_credit_limit();

INSERT INTO kha2.orders (customer_id, order_amount) VALUES
(3, 2600);
select * from kha2.orders
select * from kha2.customers

